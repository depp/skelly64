
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://depp.github.io/skelly64/vadpcm/codec/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.15">
    
    
      
        <title>VADPCM Codec - Skelly 64 Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.c382b1dc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vadpcm-codec" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Skelly 64 Documentation" class="md-header__button md-logo" aria-label="Skelly 64 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Skelly 64 Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              VADPCM Codec
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/depp/skelly64/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Skelly 64 Documentation" class="md-nav__button md-logo" aria-label="Skelly 64 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Skelly 64 Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/depp/skelly64/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../building/" class="md-nav__link">
        Building
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          VADPCM Audio
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="VADPCM Audio" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          VADPCM Audio
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Audio Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../decode/" class="md-nav__link">
        Decode VADPCM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../encode/" class="md-nav__link">
        Encode VADPCM
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          VADPCM Codec
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        VADPCM Codec
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theory-of-operation" class="md-nav__link">
    Theory of Operation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoded-data" class="md-nav__link">
    Encoded Data
  </a>
  
    <nav class="md-nav" aria-label="Encoded Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#codebook" class="md-nav__link">
    Codebook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#audio-data" class="md-nav__link">
    Audio Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decoding-process" class="md-nav__link">
    Decoding Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding-process" class="md-nav__link">
    Encoding Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wire-format" class="md-nav__link">
    Wire Format
  </a>
  
    <nav class="md-nav" aria-label="Wire Format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#predictor-vectors" class="md-nav__link">
    Predictor Vectors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-chunk-aifc" class="md-nav__link">
    Common Chunk (AIFC)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codebook-aifc" class="md-nav__link">
    Codebook (AIFC)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#audio-data_1" class="md-nav__link">
    Audio Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Font Builder
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Font Builder" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Font Builder
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../font/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../font/ttf_example/" class="md-nav__link">
        TTF Example
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../font/bitmap_example/" class="md-nav__link">
        Bitmap Example
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../image/" class="md-nav__link">
        Image Converter
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Model Converter
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Model Converter" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Model Converter
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model_format/" class="md-nav__link">
        Format
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../rom/" class="md-nav__link">
        ROM Tool
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theory-of-operation" class="md-nav__link">
    Theory of Operation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoded-data" class="md-nav__link">
    Encoded Data
  </a>
  
    <nav class="md-nav" aria-label="Encoded Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#codebook" class="md-nav__link">
    Codebook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#audio-data" class="md-nav__link">
    Audio Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decoding-process" class="md-nav__link">
    Decoding Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encoding-process" class="md-nav__link">
    Encoding Process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wire-format" class="md-nav__link">
    Wire Format
  </a>
  
    <nav class="md-nav" aria-label="Wire Format">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#predictor-vectors" class="md-nav__link">
    Predictor Vectors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-chunk-aifc" class="md-nav__link">
    Common Chunk (AIFC)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codebook-aifc" class="md-nav__link">
    Codebook (AIFC)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#audio-data_1" class="md-nav__link">
    Audio Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/depp/skelly64/edit/master/docs/vadpcm/codec.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="vadpcm-codec">VADPCM Codec</h1>
<p>This page describes the VADPCM codec in detail. With this information, you should be able to write your own VADPCM decoder.</p>
<p>Writing an encoder is more difficult.</p>
<h2 id="theory-of-operation">Theory of Operation</h2>
<p>VADPCM uses <em>linear predictors</em> to predict what each sample of audio will be, based on the previous samples. The residual difference between the predicted value and the actual value is quantized to 4 bits. Each encoded frame of audio contains 16 samples with the same predictor coefficients and residual quantization.</p>
<p>In theory, you decode a sample in two steps:</p>
<ol>
<li>
<p>Predict the sample value from a linear combination of previous output samples.</p>
</li>
<li>
<p>Add the residual value to the predicted value.</p>
</li>
</ol>
<p>The actual decoding process is different, and is easy to vectorize using SIMD operations—this may be where the “V” in “VADPCM” comes from.</p>
<h2 id="encoded-data">Encoded Data</h2>
<p>VADPCM audio consists of two parts: the <strong>codebook</strong> (which contains predictors) and the <strong>audio data</strong>.</p>
<h3 id="codebook">Codebook</h3>
<p>The codebook contains the parameters necessary for decoding the associated audio data. A codebook has a predictor order, a predictor count, and an array of predictor vectors.</p>
<dl>
<dt><strong>Predictor Order</strong></dt>
<dd>
<p>The predictor order can theoretically be any number from 0 to 8, but in practice, it is always 2. This value is the order of the linear predictors in the codebook. The predictor order is limited by the size of the array used to track decoder state in the decoder, which is 8.</p>
</dd>
<dt><strong>Predictor Count</strong></dt>
<dd>
<p>The predictor count is just the number of predictors in the codebook. This can be any number from 1 to 16. It is limited by the number of bits used to encode predictors in the encoded audio data.</p>
</dd>
<dt><strong>Predictor Vectors</strong></dt>
<dd>
<p>The predictor vectors are vectors of 8 signed 16-bit numbers. These are pre-calculated values derived during the encoding process. The number of vectors is equal to the predictor order, multiplied by the number of predictors.</p>
</dd>
</dl>
<h3 id="audio-data">Audio Data</h3>
<p>The audio data is packed into frames. Each frame is 8 bytes and contains 9 samples of audio data, giving exactly 4.5 bits per sample. A frame contains a scaling factor, a predictor index, and residual audio data.</p>
<dl>
<dt><strong>Scaling Factor</strong></dt>
<dd>
<p>The scaling factor is a number in the range 0-12. This is used to scale the residual audio data. During decoding, the residual audio data is shifted left by the scaling factor. Values larger than 12 would result in overflow when shifting.</p>
</dd>
<dt><strong>Predictor Index</strong></dt>
<dd>
<p>The predictor index is a number 0-15, which is a reference to a set of predictor vectors in the codebook. The predictor vectors are used to predict the value of future audio samples from the previous output.</p>
</dd>
<dt><strong>Residual Audio Data</strong></dt>
<dd>
<p>The residual audio data is an array of 16 four-bit numbers. This contains the difference between the predicted sample data and the actual sample data, scaled down by the scaling factor.</p>
</dd>
</dl>
<h2 id="decoding-process">Decoding Process</h2>
<p>Decoding is done in vectors of 8 samples each. Each frame contains two vectors with a shared scaling factor and predictor index. Correctly decoding a frame requires the previous frame’s decoded output, which serves as the decoder state. The initial state is all zeroes. The process for decoding a vector is as follows:</p>
<ol>
<li>
<p>Initialize an accumulator to all zeroes.</p>
</li>
<li>
<p>For a predictor order of K, multiply each of the K predictor vectors by the corresponding last K output samples, and add them to the accumulator.</p>
</li>
<li>
<p>For each index in the output vector I = 1..8,</p>
<ol>
<li>
<p>Calculate the predicted output sample by shifting the corresponding element in the accumulator to the right by 11 bits.</p>
</li>
<li>
<p>Scale the residual value by shifting it left by the frame’s scaling factor.</p>
</li>
<li>
<p>Add the scaled residual value and the predicted output sample. This is the output sample.</p>
</li>
<li>
<p>Shift the Kth predictor vector to the right by I elements, multiply this vector by the scaled residual value, and add this vector to the accumulator.</p>
</li>
</ol>
</li>
</ol>
<p>In C, you can decode a vector of VADPCM like this:</p>
<pre><code class="language-c">void decode(int predictor_order,
            int scaling_factor,
            int predictor[predictor_order][8],
            int state[8],
            int residual[8],
            int output[8]) {

  // Zero the accumulator.
  int accumulator[8];
  for (int i = 0; i &lt; 8; i++) {
    accumulator[i] = 0;
  }

  // Add previous output to accumulator.
  for (int i = 0; i &lt; predictor_order; i++) {
    int previous_output = state[8 - predictor_order + i];
    for (int j = 0; j &lt; 8; j++) {
      accumulator[j] += predictor[i][j] * previous_output;
    }
  }

  // Calculate each output sample, and update the accumulator.
  for (int i = 0; i &lt; 8; i++) {
    int scaled_residual = residual[i] &lt;&lt; scaling_factor;
    output[i] = (accumulator[i] &gt;&gt; 11) + scaled_residual;
    for (int j = 0; j &lt; 7 - i; j++) {
      accumulator[i + 1 + j] +=
          predictor[predictor_order - 1][j] * scaled_residual;
    }
  }

  // New decoder state is equal to the output.
  for (int i = 0; i &lt; 8; i++) {
    state[i] = output[i];
  }
}
</code></pre>
<h2 id="encoding-process">Encoding Process</h2>
<p>The Skelly 64 VADPCM encoder uses the following process to encode VADPCM:</p>
<ol>
<li>
<p>Break the input into frames of 16 samples each.</p>
</li>
<li>
<p>For each frame, calculate a 3x3 autocorrelation matrix.</p>
</li>
<li>
<p>Using a clustering algorithm, assign each frame to predictors. This algorithm searches for assignments that minimize the residual. The residual can be calculated from the autocorrelation matrix and the predictor coefficients, and the optimum predictor coefficients can be calculated from the autocorrelation matrix.</p>
</li>
<li>
<p>Calculate the predictor vectors from the optimum predictor coefficients for each predictor. This results in a codebook.</p>
</li>
<li>
<p>With the codebook and predictor assignments, encode each frame as VADPCM.</p>
</li>
</ol>
<h2 id="wire-format">Wire Format</h2>
<p>Only AIFC files have a known way to carry VADPCM data. However, the codec is not explicitly tied to AIFC and could easily be adapted to other formats.</p>
<h3 id="predictor-vectors">Predictor Vectors</h3>
<p>Each predictor is stored, one after the other. For example, if there are N predictors and the predictor order is K, the predictor vectors will have the following format:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int16[8]</code></td>
<td>Predictor 1, vector 1</td>
</tr>
<tr>
<td><code>int16[8]</code></td>
<td>Predictor 1, vector 2</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td><code>int16[8]</code></td>
<td>Predictor 1, vector K</td>
</tr>
<tr>
<td><code>int16[8]</code></td>
<td>Predictor 2, vector 1</td>
</tr>
<tr>
<td><code>int16[8]</code></td>
<td>Predictor 2, vector 2</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td><code>int16[8]</code></td>
<td>Predictor N, vector K</td>
</tr>
</tbody>
</table>
<h3 id="common-chunk-aifc">Common Chunk (AIFC)</h3>
<p>The <code>'COMM'</code> chunk for VADPCM-encoded AIFC files uses a sample size of 16 bits.</p>
<p>The encoding type is <code>'VAPC'</code>, and the encoding name is <code>"VADPCM ~4-1"</code>.</p>
<h3 id="codebook-aifc">Codebook (AIFC)</h3>
<p>The <code>VADPCMCODES</code> application-specific chunk in an AIFC file contains the codebook. The chunk, including its header, has the following format:</p>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>uint32</code></td>
<td>Chunk ID, <code>'APPL'</code></td>
</tr>
<tr>
<td>4</td>
<td><code>uint32</code></td>
<td>Chunk size, starting after this field</td>
</tr>
<tr>
<td>8</td>
<td><code>uint32</code></td>
<td>Application signature, <code>'stoc'</code></td>
</tr>
<tr>
<td>12</td>
<td><code>uint8</code></td>
<td>Length of chunk name, 11</td>
</tr>
<tr>
<td>13</td>
<td><code>char[11]</code></td>
<td>Chunk name, <code>"VADPCMCODES"</code></td>
</tr>
<tr>
<td>24</td>
<td><code>uint16</code></td>
<td>VADPCM codec version, 1</td>
</tr>
<tr>
<td>26</td>
<td><code>uint16</code></td>
<td>Predictor order, 0-8</td>
</tr>
<tr>
<td>28</td>
<td><code>uint16</code></td>
<td>Predictor count, 1-16</td>
</tr>
<tr>
<td>30</td>
<td><code>int16[]</code></td>
<td>Predictor vectors</td>
</tr>
</tbody>
</table>
<h3 id="audio-data_1">Audio Data</h3>
<p>A frame of audio data is stored as 9 bytes.</p>
<table>
<thead>
<tr>
<th>Offset</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>uint8</code></td>
<td>Control byte</td>
</tr>
<tr>
<td>1</td>
<td><code>uint8[8]</code></td>
<td>Residual</td>
</tr>
</tbody>
</table>
<p>The control byte stores the scaling factor as the high four bits, and the predictor index in the low four bits.</p>
<p>Each byte in the residual encodes a pair of two successive residual audio values, stored as signed four-bit numbers. The first sample in each pair is stored in the high four bits and the second sample is stored in the low four bits.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../encode/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Encode VADPCM" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Encode VADPCM
            </div>
          </div>
        </a>
      
      
        
        <a href="../../font/" class="md-footer__link md-footer__link--next" aria-label="Next: Overview" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Overview
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a6c66575.min.js"></script>
      
    
  </body>
</html>